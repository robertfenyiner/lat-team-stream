worker_processes  auto;

error_log  /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
}

# RTMP server (listens on 1935)
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            record off;
            # HLS output directory (use a persistent path, not /tmp)
            hls on;
            hls_path /var/hls;
            # Slightly longer fragments and larger playlist window reduce the chance
            # that players request segments already rotated out.
            hls_fragment 6;
            hls_playlist_length 60;
            # hls_nested creates folders per stream which can be handy for multiple streams
            hls_nested on;
        }
    }
}

# HTTP server to serve HLS fragments. Use port 8080 to avoid conflict with an existing nginx site on port 80.
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile       on;
    tcp_nopush     on;

    server {
        listen 8080;
        server_name _;

        # Serve HLS files from /var/hls
        location /hls/ {
            # MIME types for HLS
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            # Use alias so that /hls/ maps to /var/hls/
            alias /var/hls/;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin "*";
            # disable gzip for HLS
            gzip off;
        }

        # Optional: an internal location you can use with X-Accel-Redirect from your app (Laravel)
        # to enforce auth before serving the HLS files. Example flow:
        # 1) Browser requests /stream/stream.m3u8 on your app
        # 2) Laravel checks session/permissions and then responds with header:
        #    X-Accel-Redirect: /internal_hls/stream/stream.m3u8
        # 3) Nginx internal location serves the file from /var/hls
        #
        #location /internal_hls/ {
        #    internal;
        #    alias /var/hls/;
        #    add_header Cache-Control no-cache;
        #}
    }
}
